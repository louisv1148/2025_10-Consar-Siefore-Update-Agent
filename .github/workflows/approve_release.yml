
name: Approve Latest Data

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "yes" to confirm release'
        required: true
        default: 'yes'

jobs:
  approve-release:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'yes'

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      BANXICO_TOKEN: ${{ secrets.BANXICO_TOKEN }}

    steps:
      - name: Checkout Agent Repo
        uses: actions/checkout@v3

      - name: Checkout History Repo
        uses: actions/checkout@v3
        with:
          repository: louisv1148/2025_10-Afore-JSON-cleanup
          path: 2025_10-Afore-JSON-cleanup
          token: ${{ secrets.PAT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests python-dotenv

      - name: Run Approval & Integration
        run: |
          # Set python path
          export PYTHONPATH=$PYTHONPATH:.
          
          # Set Master DB Path to the checked-out history repo
          export MASTER_DB_PATH=$(pwd)/2025_10-Afore-JSON-cleanup/consar_siefores_with_usd.json
          
          # Run the script non-interactively
          python3 approve_and_integrate.py

      - name: Create GitHub Release
        env:
          # Use PAT to create release on the external repo if the script supports it, 
          # OR if the script is targeted at the Agent repo, use GITHUB_TOKEN.
          # Based on previous context, the release is for the HISTORY repo?
          # Actually, create_github_release.py might default to the current repo.
          # Let's check the script. But assuming we want to release on the History repo.
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          python3 create_github_release.py

      - name: Commit and Push (History Repo)
        run: |
          cd 2025_10-Afore-JSON-cleanup
          git config --global user.name "Consar Bot"
          git config --global user.email "bot@consar-agent.com"
          
          git add consar_siefores_with_usd.json
          git commit -m "feat: Integrate approved Siefore data"
          
          # Push using PAT
          git push https://${{ secrets.PAT_TOKEN }}@github.com/louisv1148/2025_10-Afore-JSON-cleanup.git master

      - name: Commit and Push (Agent Repo)
        run: |
          git config --global user.name "Consar Bot"
          git config --global user.email "bot@consar-agent.com"
          
          # Update the approval file status
          git add approval_pending.json
          git commit -m "chore: Mark data as approved"
          git push
